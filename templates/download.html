<!doctype html>
<html>

  <head>
    <title>Download</title>
    <link rel="stylesheet" href="./refurl/components/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./refurl/components/jqueryfiletree/jQueryFileTree.min.css">
    <script type="text/javascript" src="./refurl/components/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="./refurl/components/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./refurl/components/jqueryfiletree/jQueryFileTree.min.js"></script>
    <script>

$(init);

function init(){
  var key = "{{key}}";
  var isDir = {{isDir}};

  if (isDir){
    $("#filelist-container").show();
    $("#download-button").addClass("disabled");
    $("#download-button").attr("href", "#");
    $("#button-text").text("Select a file...");
    $("#size").text("");


    $("#filelist").fileTree({
      script: 'refurl/api/jqueryfiletree-connector',
      multiFolder: false,
      root: '{{path}}',
      key: '{{key}}'
    }).on('filetreeclicked filetreeexpand filetreecollapse', (e, data) => {
      // jqueryfiletree doesn't select directories, so I'll do it myself
      $('li.selected').removeClass('selected');
      data.li.addClass('selected');

      const button = $('#download-button');
      button.attr('href', `{{key}}/download?subpath=${data.rel}`);
      button.removeClass("disabled");
      $("#button-text").text("Download");
      getSize("{{key}}", data.rel);
    });
  }
  else {
    getSize(key, null);
  }
}

function getSize(key, subpath){
  var sizeurl = 'refurl/api/filesize?key=' + key;
  if (subpath != null) sizeurl += '&subpath=' + subpath;

  $.ajax({
    url: sizeurl,
    type: 'GET',
    success: function(result) {
      result = JSON.parse(result);
      $("#size").text(" (" + result.size + ")");
    }
  });
}

    </script>
  </head>

  <body style="padding-top:100px; background-color: #eee; text-align:center">
    <div style="width:400px; display:inline-block" class="container">
      <h2 style="text-align:center">{{name}}</h2>
      <br>
      <div id="filelist-container" style="max-height:500px; overflow:scroll; text-align: left;" class="well" hidden>
        <div id="filelist">
        </div>
      </div>
      <a id="download-button" class="button btn btn-lg btn-primary btn-block" href="{{key}}/download"><span id="button-text">Download</span><span id="size"></span></a>
    </div>
  </body>

</html>
